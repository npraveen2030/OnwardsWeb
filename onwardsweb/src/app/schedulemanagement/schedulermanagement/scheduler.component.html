<div class="scheduler-wrapper bg-light">
  <button class="btn btn-primary" (click)="onProfileClick()">Profile</button>
  <p-table
    [value]="userscheduleprofile"
    [responsiveLayout]="'scroll'"
    [scrollable]="true"
    scrollHeight="87vh"
    class="scheduler-table p-datatable-striped"
  >
    <ng-template pTemplate="header">
      <tr>
        <th>Date</th>
        <th *ngFor="let t of allTimeSlots">{{ t.label }}</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-profile>
      <tr>
        <td [ngClass]="{ 'bg-secondary': profile.info }" class="date-cell">
          {{ formatDate(profile.date) }}
        </td>

        <ng-container *ngIf="!profile.info; else infoRow">
          <td
            *ngFor="let t of timeSlots; let i = index"
            class="slot-cell"
            [ngClass]="[getColorClass(profile, i), isSelected(profile.date, i) ? 'selected' : '']"
            (mousedown)="onMouseDown(profile, i)"
            (mouseenter)="onMouseEnter(profile, i)"
            [pTooltip]="getTooltip(profile, i)"
            tooltipPosition="top"
          >
            <div class="cell-content">
              <!-- BOOKED -->
              <div *ngIf="getColorClass(profile, i) === 'scheduled'">
                <small>{{ getSubject(profile, i) }}</small>
              </div>

              <!-- AVAILABLE -->
              <div *ngIf="getColorClass(profile, i) === 'available'">
                <span class="available-text">Available</span>
              </div>

              <!-- UNAVAILABLE (NULL) -->
              <div *ngIf="getColorClass(profile, i) === 'unavailable'">
                <span class="unavailable-text">Unavailable</span>
              </div>
            </div>
          </td>
        </ng-container>

        <ng-template #infoRow>
          <td [attr.colspan]="timeSlots.length" class="bg-secondary text-center">
            {{ profile.info }}
          </td>
        </ng-template>
      </tr>
    </ng-template>
  </p-table>

  <p-dialog
    header="Selected Time Range"
    [(visible)]="showDialog"
    [modal]="true"
    [style]="{ width: '350px' }"
  >
    <div *ngIf="selectedDate && selectedTimes.length">
      <p><b>Date:</b> {{ formatDate(selectedDate) }}</p>

      <p>
        <b>Times:</b>
        <span *ngFor="let t of selectedTimes; let last = last">
          {{ getLabel(t) }}<span *ngIf="!last"> , </span>
        </span>
      </p>
    </div>

    <ng-template pTemplate="footer">
      <button pButton label="Confirm" (click)="confirmSelection()"></button>
      <button
        pButton
        label="Close"
        class="p-button-secondary"
        (click)="showDialog = false"
      ></button>
    </ng-template>
  </p-dialog>
</div>

<div
  class="modal fade"
  id="saveschedulerprofile"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
  tabindex="-1"
  aria-labelledby="staticBackdropLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header">
        <h5 class="modal-title" id="Label">Scheduler Profile</h5>
        <button type="button" class="btn-close" (click)="cancel()"></button>
      </div>

      <!-- Form -->
      <form [formGroup]="schedulerForm" (ngSubmit)="onSave()">
        <div class="modal-body">
          <div class="d-flex justify-content-center">
            <figure class="profileimage">
              <img src="assets\profilepic.png" c />
            </figure>
          </div>

          <div class="mb-3">
            <label>Summary:</label>

            <textarea
              class="form-control"
              formControlName="summary"
              maxlength="250"
              rows="4"
            ></textarea>

            <!-- Character counter -->
            <div class="text-end small text-muted">
              {{ schedulerForm.get('summary')?.value?.length || 0 }}/250
            </div>

            <!-- Validation -->
            <div
              class="text-danger small mt-1"
              *ngIf="
                schedulerForm.get('summary')?.invalid &&
                (schedulerForm.get('summary')?.touched || schedulerForm.get('summary')?.dirty)
              "
            >
              Summary is required and must be under 250 characters.
            </div>
          </div>
          <div class="mb-3">
            <label for="skills" class="form-label">Skills</label>
            <div class="d-flex gap-1">
              <div class="custom-autocomplete">
                <p-autoComplete
                  formControlName="Skillholder"
                  [suggestions]="skillsuggestions"
                  (completeMethod)="search($event)"
                  placeholder="Enter Skills"
                ></p-autoComplete>
              </div>

              <!-- Add button -->
              <button
                type="button"
                class="btn btn-success"
                (click)="addSkillFromHolder()"
                [disabled]="!schedulerForm.get('Skillholder')?.value"
              >
                <i class="bi bi-plus-circle"></i>
              </button>
            </div>

            <!-- Display added skills -->
            <ul class="list-group mt-3">
              <li
                class="list-group-item d-flex flex-column justify-content-between"
                *ngFor="let skill of skills.controls; let i = index"
              >
                <!-- Row content -->
                <div class="d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center gap-3">
                    <!-- Skill name -->
                    <span class="skillname-custom">{{ skill.value.skillName }}</span>

                    <!-- ⭐⭐⭐⭐⭐ Rating -->
                    <div class="rating-stars">
                      <i
                        *ngFor="let star of [1, 2, 3, 4, 5]"
                        class="bi"
                        [ngClass]="
                          star <= skill.value.rating ? 'bi-star-fill text-warning' : 'bi-star'
                        "
                        style="cursor: pointer; font-size: 1.2rem"
                        (click)="setRating(i, star)"
                      ></i>
                    </div>
                  </div>

                  <!-- Delete button -->
                  <button type="button" class="btn btn-sm btn-danger" (click)="removeSkill(i)">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>

                <!-- ❗ Per-skill validation -->
                <div
                  class="text-danger small mt-1"
                  *ngIf="skill.get('rating')?.value === 0 && skill.touched"
                >
                  Please select at least 1 star.
                </div>
              </li>
            </ul>

            <!-- ❗ Global validation -->
            <div class="text-danger small mt-2" *ngIf="skills.length === 0 && skills.touched">
              At least one skill is required.
            </div>
          </div>
        </div>

        <div class="modal-footer d-flex align-items-center justify-content-center gap-1">
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-secondary" (click)="reset()">Reset</button>
        </div>
      </form>
    </div>
  </div>
</div>
